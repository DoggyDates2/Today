<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üêï Dog Walking Map</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet Draw CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f8f9fa;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .controls {
            background: white;
            padding: 15px 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
            flex-shrink: 0;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-group label {
            font-weight: 600;
            color: #333;
        }

        select, input {
            padding: 6px 10px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
        }

        .group-filters {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .group-filter-btn {
            padding: 6px 12px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            font-size: 14px;
        }

        .group-filter-btn:hover {
            border-color: #667eea;
        }

        .group-filter-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .left-panel {
            width: 300px;
            background: white;
            border-right: 2px solid #e1e5e9;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .legend-section {
            border-bottom: 1px solid #e1e5e9;
            padding: 8px;
            overflow-y: auto;
            max-height: 600px;
        }

        .legend h3 {
            margin-bottom: 8px;
            color: #333;
            font-size: 15px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 1px;
            font-size: 12px;
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 3px;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .legend-item:hover {
            background-color: #f8f9fa;
            border-color: #dee2e6;
            transform: translateX(2px);
        }

        .legend-item.active {
            background-color: #e3f2fd;
            border-color: #2196F3;
            font-weight: bold;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 6px;
            border: 2px solid #333;
            flex-shrink: 0;
        }

        .legend-text {
            flex: 1;
        }

        .color-picker {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 1px solid #333;
            margin-left: 6px;
            cursor: pointer;
            flex-shrink: 0;
            padding: 0;
            background: none;
        }

        .color-picker::-webkit-color-swatch-wrapper {
            padding: 0;
            border-radius: 50%;
        }

        .color-picker::-webkit-color-swatch {
            border: none;
            border-radius: 50%;
        }

        .edit-section {
            flex: 0.7;
            padding: 8px;
            overflow-y: auto;
        }

        .edit-section h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 16px;
        }

        .no-selection {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            margin-top: 20px;
        }

        .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            font-size: 14px;
            margin: 2px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .btn-clear {
            background: #28a745;
            color: white;
        }

        .btn-clear:hover {
            background: #218838;
        }

        .btn-select {
            background: #FF6B6B;
            color: white;
        }

        .btn-select:hover {
            background: #FF5252;
        }

        .btn-select.active {
            background: #D32F2F;
        }

        .map-container {
            flex: 1;
            position: relative;
            min-height: 400px;
        }

        #map {
            width: 100%;
            height: 100%;
            min-height: 400px;
        }

        .status {
            background: white;
            padding: 8px 20px;
            text-align: center;
            font-weight: 600;
            border-top: 1px solid #e1e5e9;
            font-size: 14px;
            flex-shrink: 0;
        }

        .status.loading {
            background: #fff3cd;
            color: #856404;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
        }

        .dog-info {
            font-size: 12px;
            color: #666;
            margin: 5px 0;
        }

        .shape-legend {
            display: flex;
            gap: 15px;
            align-items: center;
            font-size: 12px;
            color: #666;
            margin-left: 10px;
        }

        .shape-legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .multi-select-info {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .multi-select-info strong {
            color: #1976D2;
        }

        .selection-mode-info {
            background: #FFE0B2;
            padding: 10px;
            text-align: center;
            font-weight: bold;
            color: #E65100;
            display: none;
        }

        .selected-marker {
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
            100% {
                transform: scale(1);
            }
        }
    </style>
</head>
<body>
    <div class="controls">
        <div class="control-group">
            <label for="colorBy">Color by:</label>
            <select id="colorBy">
                <option value="Combined">Combined (Driver:Group)</option>
                <option value="District">District</option>
            </select>
        </div>
        
        <div class="control-group">
            <label for="searchInput">Search:</label>
            <input type="text" id="searchInput" placeholder="Search dogs, combined names, addresses..." />
        </div>

        <div class="control-group group-filters">
            <label>Show Groups:</label>
            <button class="group-filter-btn active" data-group="1" onclick="toggleGroupFilter(1)">Group 1 ‚≠ï</button>
            <button class="group-filter-btn active" data-group="2" onclick="toggleGroupFilter(2)">Group 2 ‚ñ≤</button>
            <button class="group-filter-btn active" data-group="3" onclick="toggleGroupFilter(3)">Group 3 ‚ñ†</button>
        </div>

        <div class="control-group">
            <button class="btn btn-select" id="selectModeBtn" onclick="toggleSelectionMode()">‚úèÔ∏è Select Mode</button>
            <button class="btn btn-secondary" onclick="refreshData()">üîÑ Refresh</button>
            <button class="btn btn-secondary" onclick="showStats()">üìä Stats</button>
            <button class="btn btn-secondary" onclick="resetColors()">üé® Reset Colors</button>
        </div>
    </div>

    <div class="selection-mode-info" id="selectionModeInfo">
        üéØ SELECTION MODE: Draw a rectangle on the map to select multiple markers
    </div>

    <div class="main-content">
        <div class="left-panel">
            <div class="legend-section">
                <div style="text-align: center; margin-bottom: 6px;">
                    <button class="btn btn-clear" onclick="clearFilter()" style="width: 100%; padding: 6px 8px; font-size: 12px;">Show All</button>
                </div>
                
                <div class="shape-legend">
                    <div class="shape-legend-item">‚≠ï Group 1</div>
                    <div class="shape-legend-item">‚ñ≤ Group 2</div>
                    <div class="shape-legend-item">‚ñ† Group 3</div>
                </div>
                
                <div id="legendContent">Loading...</div>
            </div>
            
            <div class="edit-section">
                <div id="detailsContent" class="no-selection">
                    Click a marker on the map to see details
                </div>
            </div>
        </div>

        <div class="map-container">
            <div id="map"></div>
        </div>
    </div>

    <div class="status" id="status">Loading dog walking data...</div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet Draw JS -->
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    
    <script>
        // Configuration
        const CONFIG = {
            SHEET_ID: '1mg8d5CLxSR54KhNUL8SpL5jzrGN-bghTsC9vxSK8lR0',
            WORKSHEET_NAME: 'Map',
            API_KEY: 'AIzaSyAGLteYp1k98SZo0FMClRgBX0LBsgpMxqI',
            APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbwhtJNojYGhpG6gwiRjo3-g_qluGWx_0q5cQplyOnEsoBF8lqxMY2RAjmq4bhfj3P4AbQ/exec',
            DEFAULT_LAT: 42.2968,
            DEFAULT_LNG: -71.2636,
            DEFAULT_ZOOM: 11
        };

        // Master color palette
        const ALL_COLORS = [
            '#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd', '#8c564b', '#e377c2', '#7f7f7f',
            '#bcbd22', '#17becf', '#ff9896', '#98df8a', '#c5b0d5', '#c49c94', '#f7b6d3', '#c7c7c7',
            '#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FECA57', '#FF9FF3', '#54A0FF',
            '#5F27CD', '#00D2D3', '#FF9F43', '#10AC84', '#EE5A24', '#0097E6', '#8C7AE6', '#F79F1F',
            '#A3CB38', '#E74C3C', '#3742FA', '#2F3542', '#FF3838', '#2ECC71', '#9B59B6', '#E67E22',
            '#1ABC9C', '#34495E', '#F39C12', '#E91E63', '#00BCD4', '#607D8B', '#795548', '#009688',
            '#FF5722', '#673AB7', '#3F51B5', '#2196F3', '#03DAC6', '#6200EA', '#FF4081', '#FFAB00'
        ];

        // Global variables
        let map, markers = [], allData = [], filteredData = [], colorMap = {};
        let selectedMarker = null, selectedRow = null, currentFilter = null;
        let driverColorMap = {};
        let customColors = {};
        let activeGroups = [1, 2, 3];
        let selectionMode = false;
        let selectedMarkers = new Set();
        let drawnItems, drawControl;

        // Utility function to escape HTML
        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .toString()
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Extract group number from Combined field
        function getGroupFromCombined(combined) {
            if (!combined) return null;
            const parts = combined.split(':');
            if (parts.length > 1) {
                const groupPart = parts[1].trim();
                const match = groupPart.match(/(\d)/);
                if (match) {
                    return parseInt(match[1]);
                }
            }
            return null;
        }

        // Assign colors to drivers
        function assignDriverColors() {
            const allDrivers = [...new Set(allData.map(row => {
                const combined = row['Combined'] || '';
                const driverName = combined.split(':')[0].trim();
                return driverName;
            }).filter(driver => driver !== ''))].sort();
            
            driverColorMap = {};
            driverColorMap[''] = '#999999'; // Default color for empty drivers
            
            allDrivers.forEach((driver, index) => {
                if (index < ALL_COLORS.length) {
                    driverColorMap[driver] = ALL_COLORS[index];
                } else {
                    const hue = (index * 137.5) % 360;
                    driverColorMap[driver] = `hsl(${hue}, 70%, 50%)`;
                }
            });
        }

        // Get color for driver
        function getDriverColor(name) {
            if (!name || name.trim() === '') return '#999999';
            if (customColors[name.trim()]) return customColors[name.trim()];
            return driverColorMap[name.trim()] || '#999999';
        }

        // Get color for value based on attribute
        function getColorForValue(value, attribute) {
            if (attribute === 'Combined') {
                const driverName = value ? value.split(':')[0] : '';
                return getDriverColor(driverName);
            }
            
            if (customColors[value]) return customColors[value];
            
            const colors = ['#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd', '#8c564b'];
            let hash = 0;
            if (value) {
                for (let i = 0; i < value.length; i++) {
                    hash = value.charCodeAt(i) + ((hash << 5) - hash);
                }
            }
            return colors[Math.abs(hash) % colors.length];
        }

        // Create marker icon
        function createMarkerIcon(color, isSelected = false, markerType = 'circle', group = null, isMultiSelected = false) {
            const strokeColor = isMultiSelected ? '#FF0000' : '#000000';
            const strokeWidth = isSelected || isMultiSelected ? 3 : 2;
            const size = isMultiSelected ? 20 : 16;
            
            if (group === 1) {
                // Circle for Group 1
                return L.divIcon({
                    html: `<div class="${isMultiSelected ? 'selected-marker' : ''}" style="width: ${size}px; height: ${size}px; background-color: ${color}; border: ${strokeWidth}px solid ${strokeColor}; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>`,
                    className: 'custom-marker',
                    iconSize: [size, size],
                    iconAnchor: [size/2, size/2]
                });
            } else if (group === 2) {
                // Triangle for Group 2
                const svgSize = size + 4;
                return L.divIcon({
                    html: `<svg class="${isMultiSelected ? 'selected-marker' : ''}" width="${svgSize}" height="${svgSize}" viewBox="0 0 ${svgSize} ${svgSize}" style="filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3));">
                        <path d="M${svgSize/2} 2 L${svgSize-2} ${svgSize-2} L2 ${svgSize-2} Z" 
                              fill="${color}" stroke="${strokeColor}" stroke-width="${strokeWidth}"/>
                    </svg>`,
                    className: 'custom-triangle-marker',
                    iconSize: [svgSize, svgSize],
                    iconAnchor: [svgSize/2, svgSize/2]
                });
            } else if (group === 3) {
                // Square for Group 3
                return L.divIcon({
                    html: `<div class="${isMultiSelected ? 'selected-marker' : ''}" style="width: ${size}px; height: ${size}px; background-color: ${color}; border: ${strokeWidth}px solid ${strokeColor}; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>`,
                    className: 'custom-square-marker',
                    iconSize: [size, size],
                    iconAnchor: [size/2, size/2]
                });
            } else {
                // Default circle
                return L.divIcon({
                    html: `<div class="${isMultiSelected ? 'selected-marker' : ''}" style="width: ${size}px; height: ${size}px; background-color: ${color}; border: ${strokeWidth}px solid ${strokeColor}; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>`,
                    className: 'custom-marker',
                    iconSize: [size, size],
                    iconAnchor: [size/2, size/2]
                });
            }
        }

        // Toggle group filter
        function toggleGroupFilter(group) {
            const btn = document.querySelector(`[data-group="${group}"]`);
            const index = activeGroups.indexOf(group);
            
            if (index > -1) {
                activeGroups.splice(index, 1);
                btn.classList.remove('active');
            } else {
                activeGroups.push(group);
                btn.classList.add('active');
            }
            
            updateMap();
        }

        // Toggle selection mode
        function toggleSelectionMode() {
            if (!drawControl) {
                updateStatus('‚ùå Drawing controls not initialized', 'error');
                return;
            }
            
            selectionMode = !selectionMode;
            const btn = document.getElementById('selectModeBtn');
            const info = document.getElementById('selectionModeInfo');
            
            if (selectionMode) {
                btn.classList.add('active');
                info.style.display = 'block';
                try {
                    map.addControl(drawControl);
                } catch (e) {
                    console.error('Error adding draw control:', e);
                    selectionMode = false;
                    btn.classList.remove('active');
                    info.style.display = 'none';
                    updateStatus('‚ùå Could not enable selection mode', 'error');
                    return;
                }
                clearMultiSelection();
            } else {
                btn.classList.remove('active');
                info.style.display = 'none';
                try {
                    map.removeControl(drawControl);
                } catch (e) {
                    console.error('Error removing draw control:', e);
                }
                clearMultiSelection();
            }
        }

        // Clear multi selection
        function clearMultiSelection() {
            selectedMarkers.clear();
            if (drawnItems) {
                try {
                    drawnItems.clearLayers();
                } catch (e) {
                    console.error('Error clearing drawn items:', e);
                }
            }
            updateMarkersDisplay();
            document.getElementById('detailsContent').innerHTML = '<div class="no-selection">Click a marker on the map to see details</div>';
        }

        // Update markers display
        function updateMarkersDisplay() {
            markers.forEach(markerData => {
                const { marker, row, index, group } = markerData;
                const colorBy = document.getElementById('colorBy').value;
                let color;
                
                if (colorBy === 'Combined') {
                    const driverName = row['Combined'] ? row['Combined'].split(':')[0] : '';
                    color = colorMap[driverName] || '#999999';
                } else {
                    color = colorMap[row[colorBy]] || '#999999';
                }
                
                const isSelected = selectedMarker === marker;
                const isMultiSelected = selectedMarkers.has(marker);
                
                marker.setIcon(createMarkerIcon(color, isSelected, 'group', group, isMultiSelected));
            });
        }

        // Initialize map
        function initMap() {
            map = L.map('map').setView([CONFIG.DEFAULT_LAT, CONFIG.DEFAULT_LNG], CONFIG.DEFAULT_ZOOM]);
            
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '¬© OpenStreetMap contributors, ¬© CARTO',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);

            // Check if Leaflet Draw is loaded
            if (typeof L.Control.Draw === 'undefined') {
                console.error('Leaflet Draw plugin not loaded');
                updateStatus('‚ö†Ô∏è Multi-select feature unavailable', 'error');
                const selectBtn = document.getElementById('selectModeBtn');
                if (selectBtn) selectBtn.style.display = 'none';
                return;
            }

            // Initialize drawing features
            drawnItems = new L.FeatureGroup();
            map.addLayer(drawnItems);

            try {
                drawControl = new L.Control.Draw({
                    draw: {
                        polygon: false,
                        marker: false,
                        circlemarker: false,
                        circle: false,
                        polyline: false,
                        rectangle: {
                            shapeOptions: {
                                color: '#FF0000',
                                weight: 2,
                                fillOpacity: 0.1
                            }
                        }
                    },
                    edit: {
                        featureGroup: drawnItems,
                        edit: false,
                        remove: false
                    }
                });
            } catch (e) {
                console.error('Error initializing draw control:', e);
                const selectBtn = document.getElementById('selectModeBtn');
                if (selectBtn) selectBtn.style.display = 'none';
            }

            // Handle shape creation
            map.on(L.Draw.Event.CREATED, function (e) {
                if (!markers || markers.length === 0) {
                    updateStatus('No markers to select', 'error');
                    return;
                }
                
                const layer = e.layer;
                drawnItems.addLayer(layer);
                
                const bounds = layer.getBounds();
                selectedMarkers.clear();
                
                let foundAny = false;
                markers.forEach(markerData => {
                    if (markerData && markerData.marker) {
                        const markerLatLng = markerData.marker.getLatLng();
                        if (bounds.contains(markerLatLng)) {
                            selectedMarkers.add(markerData.marker);
                            foundAny = true;
                        }
                    }
                });
                
                updateMarkersDisplay();
                
                if (selectedMarkers.size > 0) {
                    showMultiEditUI();
                } else if (!foundAny) {
                    updateStatus('No markers found in selection area', 'error');
                }
                
                setTimeout(() => {
                    drawnItems.clearLayers();
                }, 500);
            });

            document.getElementById('colorBy').addEventListener('change', updateMap);
            document.getElementById('searchInput').addEventListener('input', updateMap);
        }

        // Show multi edit UI
        function showMultiEditUI() {
            const selectedData = [];
            markers.forEach(markerData => {
                if (selectedMarkers.has(markerData.marker)) {
                    selectedData.push(markerData.row);
                }
            });
            
            const currentDrivers = [...new Set(selectedData.map(row => {
                const combined = row['Combined'] || '';
                return combined.split(':')[0];
            }))];
            
            const driverText = currentDrivers.length === 1 ? currentDrivers[0] : 'Multiple drivers';
            
            const detailsHtml = `
                <div class="multi-select-info">
                    <strong>üéØ ${selectedMarkers.size} markers selected</strong>
                </div>
                
                <div style="font-weight: bold; color: #333; margin-bottom: 8px; font-size: 14px;">
                    Bulk Edit Driver Name
                </div>
                
                <div style="margin-bottom: 8px;">
                    <input type="text" id="editDriverMulti" placeholder="${escapeHtml(driverText)}" 
                           style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                    <small style="color: #666;">Enter new driver name (groups will be preserved)</small>
                </div>
                
                <div style="display: flex; gap: 4px;">
                    <button class="btn btn-primary" onclick="saveMultipleCombinedNames()" style="flex: 1; padding: 6px 8px; font-size: 12px;">Save All</button>
                    <button class="btn btn-secondary" onclick="clearMultiSelection()" style="flex: 1; padding: 6px 8px; font-size: 12px;">Cancel</button>
                </div>
                
                <div style="margin-top: 15px; max-height: 200px; overflow-y: auto; font-size: 12px;">
                    <strong>Selected Dogs:</strong><br>
                    ${selectedData.map(row => {
                        const combined = row['Combined'] || '';
                        const parts = combined.split(':');
                        const driver = parts[0] || 'No driver';
                        const group = parts.length > 1 ? ` (Group ${parts[1]})` : '';
                        return `‚Ä¢ ${escapeHtml(row['Dog Name'] || '')} - ${escapeHtml(driver)}${group}`;
                    }).join('<br>')}
                </div>
            `;
            
            document.getElementById('detailsContent').innerHTML = detailsHtml;
        }

        // Load data from Google Sheets
        async function loadData() {
            updateStatus('Loading data...', 'loading');
            
            try {
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}/values/${CONFIG.WORKSHEET_NAME}?key=${CONFIG.API_KEY}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (!data.values || data.values.length < 2) {
                    throw new Error('No data found in the sheet');
                }
                
                const headers = data.values[0];
                const rows = data.values.slice(1);
                
                allData = rows.map(row => {
                    const obj = {};
                    headers.forEach((header, index) => {
                        obj[header] = row[index] || '';
                    });
                    return obj;
                }).filter(row => {
                    const lat = parseFloat(row['Latitude']);
                    const lng = parseFloat(row['Longitude']);
                    return !isNaN(lat) && !isNaN(lng) && row['Dog Name'] && lat !== 0 && lng !== 0;
                });

                updateStatus(`‚úÖ Loaded ${allData.length} locations`, 'success');
                
                assignDriverColors();
                updateMap();
                
            } catch (error) {
                updateStatus(`Error: ${error.message}`, 'error');
                console.error('Data loading error:', error);
            }
        }

        // Update map with current data and filters
        function updateMap() {
            const colorBy = document.getElementById('colorBy').value;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            // Filter data
            filteredData = allData.filter(row => {
                const searchText = `${row['Dog Name']} ${row['Address']} ${row['District']} ${row['Combined']} ${row['Callout']}`.toLowerCase();
                const matchesSearch = searchText.includes(searchTerm);
                
                const group = getGroupFromCombined(row['Combined']);
                const matchesGroup = group === null || activeGroups.includes(group);
                
                let matchesFilter = currentFilter === null;
                if (!matchesFilter && currentFilter !== null) {
                    if (colorBy === 'Combined') {
                        const driverName = row['Combined'] ? row['Combined'].split(':')[0].trim() : '';
                        matchesFilter = driverName === currentFilter;
                    } else {
                        matchesFilter = row[colorBy] === currentFilter;
                    }
                }
                
                return matchesSearch && matchesFilter && matchesGroup;
            });

            // Clear existing markers
            markers.forEach(m => map.removeLayer(m.marker));
            markers = [];

            // Update color map
            if (colorBy === 'Combined') {
                const uniqueDrivers = [...new Set(allData.map(row => {
                    const combined = row['Combined'] || '';
                    return combined.split(':')[0];
                }).filter(driver => driver !== undefined))];
                
                colorMap = {};
                uniqueDrivers.forEach(driver => {
                    colorMap[driver] = getDriverColor(driver);
                });
            } else {
                const uniqueValues = [...new Set(allData.map(row => row[colorBy]))];
                colorMap = {};
                uniqueValues.forEach(value => {
                    colorMap[value] = getColorForValue(value, colorBy);
                });
            }

            // Add markers
            filteredData.forEach((row, index) => {
                const lat = parseFloat(row['Latitude']);
                const lng = parseFloat(row['Longitude']);
                if (isNaN(lat) || isNaN(lng)) return;

                let color;
                if (colorBy === 'Combined') {
                    const driverName = row['Combined'] ? row['Combined'].split(':')[0] : '';
                    color = colorMap[driverName] || '#999999';
                } else {
                    color = colorMap[row[colorBy]] || '#999999';
                }
                
                const isSelected = selectedRow === row;
                const group = getGroupFromCombined(row['Combined']);
                
                const marker = L.marker([lat, lng], {
                    icon: createMarkerIcon(color, isSelected, 'group', group)
                }).addTo(map);

                const groupText = group ? `Group ${group}` : 'No Group';
                const popupContent = `
                    <strong>üêï ${escapeHtml(row['Dog Name'] || '')}</strong><br>
                    <strong>üè∑Ô∏è ${escapeHtml(row['Combined'] || '')}</strong><br>
                    <strong>üìã ${groupText}</strong><br>
                    ${escapeHtml(row['Address'] || '')}<br>
                    ${row['District'] && row['District'].trim() !== '' ? `${escapeHtml(row['District'])}<br>` : ''}
                    ${row['Capacity'] && row['Capacity'].trim() !== '' ? `${escapeHtml(row['Capacity'])}<br>` : ''}
                    ${row['Callout'] && row['Callout'].trim() !== '' ? `<strong>üìù CALLOUT:</strong> <span style="background: yellow; padding: 2px;">${escapeHtml(row['Callout'])}</span><br>` : ''}
                `;

                marker.bindPopup(popupContent);
                marker.on('click', () => {
                    if (!selectionMode) {
                        selectMarker(marker, row, index, group);
                    }
                });

                markers.push({marker, row, index, group});
            });

            updateLegend();
            updateStatus(`Showing ${filteredData.length} of ${allData.length} locations`, 'success');
        }

        // Update legend
        function updateLegend() {
            const colorBy = document.getElementById('colorBy').value;
            const legendContent = document.getElementById('legendContent');
            legendContent.innerHTML = '';
            
            if (colorBy === 'Combined') {
                Object.entries(colorMap).sort(([a], [b]) => a.localeCompare(b)).forEach(([driverName, color]) => {
                    const isActive = currentFilter === driverName;
                    
                    const groupCounts = { 1: 0, 2: 0, 3: 0 };
                    allData.forEach(row => {
                        const combined = row['Combined'] || '';
                        if (combined.split(':')[0] === driverName) {
                            const group = getGroupFromCombined(combined);
                            if (group && groupCounts[group] !== undefined) {
                                groupCounts[group]++;
                            }
                        }
                    });
                    
                    const counts = [];
                    for (let i = 1; i <= 3; i++) {
                        if (groupCounts[i] > 0) {
                            counts.push(groupCounts[i]);
                        }
                    }
                    const countsDisplay = counts.length > 0 ? ' ' + counts.join(', ') : '';
                    
                    const legendItem = document.createElement('div');
                    legendItem.className = `legend-item ${isActive ? 'active' : ''}`;
                    legendItem.dataset.category = driverName;
                    legendItem.onclick = function() { filterByCategory(driverName); };
                    
                    legendItem.innerHTML = `
                        <div class="legend-color" style="background-color: ${color}"></div>
                        <span class="legend-text">${escapeHtml(driverName)}${countsDisplay}</span>
                        <input type="color" class="color-picker" value="${color}" 
                               onclick="event.stopPropagation()">
                    `;
                    
                    const colorPicker = legendItem.querySelector('.color-picker');
                    colorPicker.onchange = function(e) {
                        e.stopPropagation();
                        changeCustomColor(driverName, this.value);
                    };
                    
                    legendContent.appendChild(legendItem);
                });
            } else {
                Object.entries(colorMap).sort(([a], [b]) => a.localeCompare(b)).forEach(([category, color]) => {
                    const isActive = currentFilter === category;
                    
                    const legendItem = document.createElement('div');
                    legendItem.className = `legend-item ${isActive ? 'active' : ''}`;
                    legendItem.dataset.category = category;
                    legendItem.onclick = function() { filterByCategory(category); };
                    
                    legendItem.innerHTML = `
                        <div class="legend-color" style="background-color: ${color}"></div>
                        <span class="legend-text">${escapeHtml(category)}</span>
                        <input type="color" class="color-picker" value="${color}" 
                               onclick="event.stopPropagation()">
                    `;
                    
                    const colorPicker = legendItem.querySelector('.color-picker');
                    colorPicker.onchange = function(e) {
                        e.stopPropagation();
                        changeCustomColor(category, this.value);
                    };
                    
                    legendContent.appendChild(legendItem);
                });
            }
        }

        // Change custom color
        function changeCustomColor(categoryName, newColor) {
            if (!newColor || !newColor.match(/^#[0-9A-Fa-f]{6}$/)) {
                console.error('Invalid color format:', newColor);
                return;
            }
            
            console.log('Changing color for:', categoryName, 'to:', newColor);
            customColors[categoryName] = newColor;
            updateMap();
        }

        // Reset colors
        function resetColors() {
            console.log('Resetting all custom colors');
            customColors = {};
            updateMap();
        }

        // Select marker
        function selectMarker(marker, row, index, group) {
            if (selectedMarker) {
                const prevData = markers.find(m => m.marker === selectedMarker);
                if (prevData) {
                    const colorBy = document.getElementById('colorBy').value;
                    let color;
                    if (colorBy === 'Combined') {
                        const driverName = prevData.row['Combined'] ? prevData.row['Combined'].split(':')[0] : '';
                        color = colorMap[driverName] || '#999999';
                    } else {
                        color = colorMap[prevData.row[colorBy]] || '#999999';
                    }
                    selectedMarker.setIcon(createMarkerIcon(color, false, 'group', prevData.group));
                }
            }

            selectedMarker = marker;
            selectedRow = row;
            
            const colorBy = document.getElementById('colorBy').value;
            let color;
            if (colorBy === 'Combined') {
                const driverName = row['Combined'] ? row['Combined'].split(':')[0] : '';
                color = colorMap[driverName] || '#999999';
            } else {
                color = colorMap[row[colorBy]] || '#999999';
            }
            marker.setIcon(createMarkerIcon(color, true, 'group', group));

            const actualIndex = allData.findIndex(r => r === row);
            const groupText = group ? `Group ${group}` : 'No Group';
            
            const currentCombined = row['Combined'] || '';
            const combinedParts = currentCombined.split(':');
            const currentDriver = combinedParts[0] || '';
            const currentGroup = combinedParts.length > 1 ? ':' + combinedParts.slice(1).join(':') : '';
            
            const detailsHtml = `
                <div style="font-weight: bold; color: #333; margin-bottom: 8px; font-size: 14px;">
                    ${escapeHtml(row['Dog Name'] || '')} (${groupText})
                </div>
                
                <div style="margin-bottom: 8px;">
                    <div style="display: flex; align-items: center; gap: 4px;">
                        <input type="text" id="editDriver" value="${escapeHtml(currentDriver)}" 
                               style="flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                        <span style="font-weight: bold; color: #666;">${escapeHtml(currentGroup)}</span>
                    </div>
                    <small style="color: #666;">Edit driver name only (group preserved)</small>
                </div>
                
                <div style="display: flex; gap: 4px;">
                    <button class="btn btn-primary" onclick="saveCombinedName(${actualIndex})" style="flex: 1; padding: 6px 8px; font-size: 12px;">Save</button>
                    <button class="btn btn-secondary" onclick="cancelEdit()" style="flex: 1; padding: 6px 8px; font-size: 12px;">Cancel</button>
                </div>
            `;
            
            document.getElementById('detailsContent').innerHTML = detailsHtml;
        }

        // Filter by category
        function filterByCategory(category) {
            if (typeof category !== 'string') {
                console.error('Invalid category:', category);
                return;
            }
            
            currentFilter = currentFilter === category ? null : category;
            updateMap();
        }

        // Clear filter
        function clearFilter() {
            currentFilter = null;
            document.getElementById('searchInput').value = '';
            updateMap();
        }

        // Show statistics
        function showStats() {
            if (!allData || allData.length === 0) {
                alert('No data available to show statistics');
                return;
            }
            
            try {
                const drivers = allData.reduce((acc, row) => {
                    const combined = row['Combined'] || '';
                    const driverName = combined.split(':')[0];
                    if (driverName && driverName.trim() !== '') {
                        acc[driverName] = (acc[driverName] || 0) + 1;
                    }
                    return acc;
                }, {});
                
                const districts = allData.reduce((acc, row) => {
                    if (row['District'] && row['District'].trim() !== '') {
                        acc[row['District']] = (acc[row['District']] || 0) + 1;
                    }
                    return acc;
                }, {});
                
                const groups = { 1: 0, 2: 0, 3: 0, 'None': 0 };
                allData.forEach(row => {
                    const group = getGroupFromCombined(row['Combined']);
                    if (group && groups[group] !== undefined) {
                        groups[group]++;
                    } else {
                        groups['None']++;
                    }
                });
                
                let statsText = "üìä DETAILED STATISTICS\n\n";
                
                statsText += "üî¢ GROUPS:\n";
                Object.entries(groups).forEach(([group, count]) => {
                    if (count > 0) {
                        statsText += `  Group ${group}: ${count} dogs\n`;
                    }
                });
                
                statsText += "\nüë§ DRIVERS:\n";
                Object.entries(drivers).sort((a, b) => b[1] - a[1]).forEach(([name, count]) => {
                    statsText += `  ${name}: ${count} dogs\n`;
                });
                
                statsText += "\nüó∫Ô∏è DISTRICTS:\n";
                Object.entries(districts).sort((a, b) => b[1] - a[1]).forEach(([district, count]) => {
                    statsText += `  ${district}: ${count} dogs\n`;
                });
                
                alert(statsText);
            } catch (e) {
                console.error('Error generating statistics:', e);
                alert('Error generating statistics. Please check the console for details.');
            }
        }

        // Save combined name (single)
        async function saveCombinedName(index) {
            const newDriver = document.getElementById('editDriver').value.trim();
            
            if (!selectedRow || typeof index !== 'number' || !allData[index]) {
                updateStatus('‚ùå Error: Invalid selection', 'error');
                return;
            }

            const actualIndex = allData.findIndex(row => row === selectedRow);
            if (actualIndex === -1) {
                updateStatus('‚ùå Error: Could not find row in data', 'error');
                return;
            }

            const currentCombined = selectedRow['Combined'] || '';
            const combinedParts = currentCombined.split(':');
            const groupPart = combinedParts.length > 1 ? ':' + combinedParts.slice(1).join(':') : '';
            
            const newCombined = newDriver + groupPart;

            selectedRow['Combined'] = newCombined;
            allData[actualIndex]['Combined'] = newCombined;
            
            if (CONFIG.APPS_SCRIPT_URL && CONFIG.APPS_SCRIPT_URL.trim() !== '' && !CONFIG.APPS_SCRIPT_URL.includes('YOUR_APPS_SCRIPT_URL_HERE')) {
                try {
                    updateStatus('üíæ Saving to Google Sheets...', 'loading');
                    
                    const payload = {
                        action: 'updateCombined',
                        rowIndex: actualIndex + 2,
                        dogId: selectedRow['Dog ID'] || '',
                        newCombined: newCombined
                    };
                    
                    console.log('üîß DEBUG: Sending to Apps Script:', payload);
                    
                    const response = await fetch(CONFIG.APPS_SCRIPT_URL, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload),
                        mode: 'cors'
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            updateStatus(`‚úÖ Saved to Google Sheets: ${newCombined}`, 'success');
                        } else {
                            throw new Error(result.error || 'Unknown error from Apps Script');
                        }
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                } catch (error) {
                    console.error('üîß DEBUG: Google Sheets save error:', error);
                    
                    // Try no-cors as fallback - fire and forget
                    fetch(CONFIG.APPS_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'updateCombined',
                            rowIndex: actualIndex + 2,
                            dogId: selectedRow['Dog ID'] || '',
                            newCombined: newCombined
                        })
                    }).then(() => {
                        console.log('No-cors request sent');
                    }).catch(noCorsError => {
                        console.error('üîß DEBUG: No-cors also failed:', noCorsError);
                    });
                    
                    updateStatus(`‚ö†Ô∏è Saved locally only. Sheets error: ${error.message}`, 'error');
                }
            } else {
                if (CONFIG.APPS_SCRIPT_URL.includes('YOUR_APPS_SCRIPT_URL_HERE')) {
                    updateStatus(`‚ö†Ô∏è Updated locally only. Please configure APPS_SCRIPT_URL`, 'error');
                } else {
                    updateStatus(`‚úÖ Updated locally: ${newCombined}`, 'success');
                }
            }
            
            assignDriverColors();
            updateMap();
            
            if (selectedMarker) {
                const markerData = markers.find(m => m.marker === selectedMarker);
                if (markerData) {
                    const newGroup = getGroupFromCombined(newCombined);
                    selectMarker(selectedMarker, selectedRow, actualIndex, newGroup);
                }
            }
        }

        // Save multiple combined names
        async function saveMultipleCombinedNames() {
            const newDriver = document.getElementById('editDriverMulti').value.trim();
            
            const selectedData = [];
            markers.forEach(markerData => {
                if (selectedMarkers.has(markerData.marker)) {
                    selectedData.push({
                        row: markerData.row,
                        index: allData.findIndex(r => r === markerData.row)
                    });
                }
            });
            
            updateStatus(`üíæ Updating ${selectedData.length} records...`, 'loading');
            
            selectedData.forEach(({row, index}) => {
                if (index !== -1) {
                    const currentCombined = row['Combined'] || '';
                    const combinedParts = currentCombined.split(':');
                    const groupPart = combinedParts.length > 1 ? ':' + combinedParts.slice(1).join(':') : '';
                    
                    const newCombined = newDriver + groupPart;
                    row['Combined'] = newCombined;
                    allData[index]['Combined'] = newCombined;
                }
            });
            
            if (CONFIG.APPS_SCRIPT_URL && CONFIG.APPS_SCRIPT_URL.trim() !== '' && !CONFIG.APPS_SCRIPT_URL.includes('YOUR_APPS_SCRIPT_URL_HERE')) {
                try {
                    const updates = selectedData.map(({row, index}) => {
                        const currentCombined = row['Combined'] || '';
                        const combinedParts = currentCombined.split(':');
                        const groupPart = combinedParts.length > 1 ? ':' + combinedParts.slice(1).join(':') : '';
                        const newCombined = newDriver + groupPart;
                        
                        return {
                            rowIndex: index + 2,
                            dogId: row['Dog ID'] || '',
                            newCombined: newCombined
                        };
                    });
                    
                    const response = await fetch(CONFIG.APPS_SCRIPT_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'batchUpdateCombined',
                            updates: updates
                        }),
                        mode: 'cors'
                    });
                    
                    if (response.ok) {
                        const driverText = newDriver || '(empty)';
                        updateStatus(`‚úÖ Updated ${selectedData.length} records to driver: ${driverText}`, 'success');
                    }
                } catch (error) {
                    console.error('Batch update error:', error);
                    updateStatus(`‚ö†Ô∏è Updated locally only. Sheets error: ${error.message}`, 'error');
                }
            } else {
                const driverText = newDriver || '(empty)';
                updateStatus(`‚úÖ Updated ${selectedData.length} records locally to driver: ${driverText}`, 'success');
            }
            
            clearMultiSelection();
            assignDriverColors();
            updateMap();
        }

        // Cancel edit
        function cancelEdit() {
            if (selectedMarker && selectedRow) {
                const markerData = markers.find(m => m.marker === selectedMarker);
                if (markerData) {
                    const index = allData.findIndex(row => row === selectedRow);
                    if (index !== -1) {
                        selectMarker(selectedMarker, selectedRow, index, markerData.group);
                    }
                }
            } else {
                document.getElementById('detailsContent').innerHTML = '<div class="no-selection">Click a marker on the map to see details</div>';
            }
        }

        // Refresh data
        function refreshData() {
            if (selectionMode) {
                toggleSelectionMode();
            }
            
            selectedMarker = null;
            selectedRow = null;
            currentFilter = null;
            selectedMarkers.clear();
            document.getElementById('detailsContent').innerHTML = '<div class="no-selection">Click a marker on the map to see details</div>';
            loadData();
        }

        // Update status
        function updateStatus(message, type = '') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }

        // Initialize on DOM ready
        document.addEventListener('DOMContentLoaded', function() {
            const requiredElements = ['map', 'colorBy', 'searchInput', 'legendContent', 'detailsContent', 'status'];
            let allElementsExist = true;
            
            requiredElements.forEach(id => {
                if (!document.getElementById(id)) {
                    console.error(`Required element missing: ${id}`);
                    allElementsExist = false;
                }
            });
            
            if (!allElementsExist) {
                alert('Error: Some required page elements are missing. Please refresh the page.');
                return;
            }
            
            try {
                initMap();
                loadData();
            } catch (e) {
                console.error('Error initializing application:', e);
                updateStatus('‚ùå Error initializing map', 'error');
            }
        });
    </script>
</body>
</html>
