<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üêï Dog Walking Interactive Map v2 - IMPROVED</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f8f9fa;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }

        .header h1 {
            font-size: 1.8em;
            margin-bottom: 5px;
        }

        .controls {
            background: white;
            padding: 10px 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
            flex-shrink: 0;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-group label {
            font-weight: 600;
            color: #333;
        }

        select, input {
            padding: 6px 10px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
        }

        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .left-panel {
            width: 300px;
            background: white;
            border-right: 2px solid #e1e5e9;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .legend-section {
            border-bottom: 2px solid #e1e5e9;
            padding: 15px;
            overflow-y: auto;
            max-height: 300px;
        }

        .legend h3 {
            margin-bottom: 10px;
            color: #333;
            font-size: 16px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 14px;
            cursor: pointer;
            padding: 8px;
            border-radius: 4px;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .legend-item:hover {
            background-color: #f8f9fa;
            border-color: #dee2e6;
            transform: translateX(2px);
        }

        .legend-item.active {
            background-color: #e3f2fd;
            border-color: #2196F3;
            font-weight: bold;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 10px;
            border: 2px solid #333;
            flex-shrink: 0;
        }

        .edit-section {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
        }

        .edit-section h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 16px;
        }

        .no-selection {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            margin-top: 50px;
        }

        .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            font-size: 14px;
            margin: 2px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .btn-clear {
            background: #28a745;
            color: white;
        }

        .btn-clear:hover {
            background: #218838;
        }

        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .status {
            background: white;
            padding: 8px 20px;
            text-align: center;
            font-weight: 600;
            border-top: 1px solid #e1e5e9;
            font-size: 14px;
            flex-shrink: 0;
        }

        .status.loading {
            background: #fff3cd;
            color: #856404;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
        }

        .dog-info {
            font-size: 12px;
            color: #666;
            margin: 5px 0;
        }

        .stats-box {
            background: #f8f9fa;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #667eea;
        }

        .version-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ff4444;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="version-badge">üÜï UPDATED v2</div>
    
    <div class="header">
        <h1>üêï Dog Walking Interactive Map - IMPROVED VERSION</h1>
        <p>üó∫Ô∏è Street Names Visible ‚Ä¢ üìù Callouts ‚Ä¢ üë• Capacity ‚Ä¢ üíæ Google Sheets Sync ‚Ä¢ üé® Driver Color Grouping</p>
    </div>

    <div class="controls">
        <div class="control-group">
            <label for="colorBy">Color by:</label>
            <select id="colorBy">
                <option value="Combined">Combined (Driver:Group)</option>
                <option value="Group">Group</option>
                <option value="District">District</option>
            </select>
        </div>
        
        <div class="control-group">
            <label for="searchInput">Search:</label>
            <input type="text" id="searchInput" placeholder="Search dogs, combined names, addresses..." />
        </div>

        <div class="control-group">
            <button class="btn btn-secondary" onclick="refreshData()">üîÑ Refresh</button>
            <button class="btn btn-secondary" onclick="showStats()">üìä Stats</button>
        </div>
    </div>

    <div class="main-content">
        <div class="left-panel">
            <div class="legend-section">
                <h3>üé® Legend (Click to Filter)</h3>
                <div id="filterStatus" style="font-size: 12px; color: #666; margin-bottom: 10px; font-style: italic;"></div>
                <div id="combinedHelp" style="font-size: 11px; color: #888; margin-bottom: 8px; font-style: italic; display: none;">
                    ‚ÑπÔ∏è Combined view groups by driver name (part before ":"). All entries for same driver share one color.
                </div>
                <div id="legendContent">Loading...</div>
                <div style="text-align: center; margin-top: 10px;">
                    <button class="btn btn-clear" onclick="clearFilter()" style="width: 100%;">Show All</button>
                </div>
            </div>
            
            <div class="edit-section">
                <h3>üìã Details & Edit</h3>
                <div id="detailsContent" class="no-selection">
                    Click a marker on the map to see details
                </div>
                
                <div class="stats-box" id="statsBox">
                    <strong>üìä Quick Stats:</strong>
                    <div id="quickStats">Loading...</div>
                </div>
                
                <div style="background: #e7f3ff; padding: 10px; margin: 10px 0; border-radius: 5px; border-left: 4px solid #2196F3; font-size: 12px;">
                    <strong>üéØ Marker Types:</strong><br>
                    ‚≠ï Circle = Regular dog<br>
                    üìç Pin = Has callout notes<br>
                    üÖøÔ∏è Square = Parking location<br>
                    üìå Large Pin = Field location
                </div>
                
                <div style="background: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 5px; font-size: 11px; color: #666;">
                    <strong>üíæ Google Sheets Sync:</strong><br>
                    Edits save locally. To sync back to Google Sheets, you need to set up a Google Apps Script. 
                    <br><br>
                    <button class="btn btn-secondary" onclick="showAppsScriptHelp()" style="font-size: 11px; padding: 5px 8px;">üìñ Show Setup</button>
                </div>
            </div>
        </div>

        <div class="map-container">
            <div id="map"></div>
        </div>
    </div>

    <div class="status" id="status">Loading dog walking data...</div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // Configuration - using your exact sheet details
        const CONFIG = {
            SHEET_ID: '1mg8d5CLxSR54KhNUL8SpL5jzrGN-bghTsC9vxSK8lR0',
            WORKSHEET_NAME: 'Map',
            API_KEY: 'AIzaSyAGLteYp1k98SZo0FMClRgBX0LBsgpMxqI',
            // ADD YOUR GOOGLE APPS SCRIPT WEB APP URL HERE FOR EDITING:
            APPS_SCRIPT_URL: '', // Leave empty if you don't have one yet
            // Wellesley, MA coordinates
            DEFAULT_LAT: 42.2968,
            DEFAULT_LNG: -71.2636,
            DEFAULT_ZOOM: 11
        };

        // Color mapping for drivers
        const DRIVER_COLORS = {
            'Nate': '#1f77b4', 'Aidan': '#ff7f0e', 'Sarah': '#2ca02c', 'Victor': '#d62728',
            'Emily': '#9467bd', 'Mike': '#8c564b', 'Lisa': '#e377c2', 'David': '#7f7f7f',
            'Anna': '#bcbd22', 'Chris': '#17becf', 'Jess': '#ff9896', 'Tom': '#98df8a',
            'Sam': '#c5b0d5', 'Alex': '#c49c94', 'Jordan': '#f7b6d3', 'Taylor': '#c7c7c7'
        };

        // Global variables
        let map, markers = [], allData = [], filteredData = [], colorMap = {};
        let selectedMarker = null, selectedRow = null, currentFilter = null;

        // Helper functions
        function getDriverColor(name) {
            if (!name) return '#999999';
            return DRIVER_COLORS[name] || '#' + Math.floor(Math.random()*16777215).toString(16);
        }

        function getColorForValue(value, attribute) {
            if (attribute === 'Name' || attribute === 'Combined') {
                // For both Name and Combined, extract driver name for consistent coloring
                let driverName = value;
                if (attribute === 'Combined') {
                    driverName = value ? value.split(':')[0] : '';
                }
                return getDriverColor(driverName);
            }
            
            // Generate consistent colors for other attributes
            const colors = ['#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd', '#8c564b', '#e377c2', '#7f7f7f', '#bcbd22', '#17becf'];
            let hash = 0;
            if (value) {
                for (let i = 0; i < value.length; i++) {
                    hash = value.charCodeAt(i) + ((hash << 5) - hash);
                }
            }
            return colors[Math.abs(hash) % colors.length];
        }

        function createMarkerIcon(color, isSelected = false, markerType = 'circle') {
            const strokeColor = isSelected ? '#000000' : '#ffffff';
            const strokeWidth = isSelected ? 3 : 2;
            
            if (markerType === 'field') {
                // Large pin for fields
                const size = 32;
                return L.divIcon({
                    html: `<svg width="${size}" height="${size + 8}" viewBox="0 0 32 40" style="filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3));">
                        <path d="M16 0C7.2 0 0 7.2 0 16c0 9.6 16 24 16 24s16-14.4 16-24C32 7.2 24.8 0 16 0z" 
                              fill="${color}" 
                              stroke="${strokeColor}" 
                              stroke-width="${strokeWidth}"/>
                        <circle cx="16" cy="16" r="8" fill="rgba(255,255,255,0.3)"/>
                        <text x="16" y="20" text-anchor="middle" fill="white" font-size="10" font-weight="bold">F</text>
                    </svg>`,
                    className: 'custom-field-marker',
                    iconSize: [size, size + 8],
                    iconAnchor: [size/2, size + 8]
                });
            } else if (markerType === 'parking') {
                // Large square for parking
                const size = 28;
                return L.divIcon({
                    html: `<div style="width: ${size}px; height: ${size}px; background-color: ${color}; border: ${strokeWidth}px solid ${strokeColor}; box-shadow: 0 2px 4px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px;">P</div>`,
                    className: 'custom-parking-marker',
                    iconSize: [size, size],
                    iconAnchor: [size/2, size/2]
                });
            } else if (markerType === 'pin') {
                // Pin shape for callout items
                const size = 24;
                return L.divIcon({
                    html: `<svg width="${size}" height="${size + 6}" viewBox="0 0 24 30" style="filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3));">
                        <path d="M12 0C5.4 0 0 5.4 0 12c0 7.2 12 18 12 18s12-10.8 12-18C24 5.4 18.6 0 12 0z" 
                              fill="${color}" 
                              stroke="${strokeColor}" 
                              stroke-width="${strokeWidth}"/>
                        <circle cx="12" cy="12" r="6" fill="rgba(255,255,255,0.3)"/>
                    </svg>`,
                    className: 'custom-pin-marker',
                    iconSize: [size, size + 6],
                    iconAnchor: [size/2, size + 6]
                });
            } else {
                // Default circle
                const size = 20;
                return L.divIcon({
                    html: `<div style="width: ${size}px; height: ${size}px; background-color: ${color}; border: ${strokeWidth}px solid ${strokeColor}; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>`,
                    className: 'custom-marker',
                    iconSize: [size, size],
                    iconAnchor: [size/2, size/2]
                });
            }
        }

        // Initialize map
        function initMap() {
            map = L.map('map').setView([CONFIG.DEFAULT_LAT, CONFIG.DEFAULT_LNG], CONFIG.DEFAULT_ZOOM);
            
            // IMPROVED MAP TILES - Shows street names and town names clearly!
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            document.getElementById('colorBy').addEventListener('change', updateMap);
            document.getElementById('searchInput').addEventListener('input', updateMap);
        }

        // Load data from Google Sheets
        async function loadData() {
            updateStatus('Loading data...', 'loading');
            
            try {
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}/values/${CONFIG.WORKSHEET_NAME}?key=${CONFIG.API_KEY}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (!data.values || data.values.length < 2) {
                    throw new Error('No data found in the sheet');
                }
                
                const headers = data.values[0];
                const rows = data.values.slice(1);
                
                allData = rows.map(row => {
                    const obj = {};
                    headers.forEach((header, index) => {
                        obj[header] = row[index] || '';
                    });
                    return obj;
                }).filter(row => {
                    const lat = parseFloat(row['Latitude']);
                    const lng = parseFloat(row['Longitude']);
                    return !isNaN(lat) && !isNaN(lng) && row['Dog Name'] && lat !== 0 && lng !== 0;
                });

                updateStatus(`‚úÖ Loaded ${allData.length} locations with street names visible!`, 'success');
                updateQuickStats();
                updateMap();
                
            } catch (error) {
                updateStatus(`Error: ${error.message}`, 'error');
                console.error('Data loading error:', error);
            }
        }

        // Update map with current filters
        function updateMap() {
            const colorBy = document.getElementById('colorBy').value;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            // Filter data - NOW INCLUDES COMBINED AND CALLOUT IN SEARCH
            filteredData = allData.filter(row => {
                const searchText = `${row['Dog Name']} ${row['Address']} ${row['District']} ${row['Combined']} ${row['Callout']}`.toLowerCase();
                const matchesSearch = searchText.includes(searchTerm);
                
                let matchesFilter = currentFilter === null;
                if (!matchesFilter && currentFilter !== null) {
                    if (colorBy === 'Combined') {
                        // For Combined, filter by driver name (part before colon)
                        const driverName = row['Combined'] ? row['Combined'].split(':')[0] : '';
                        matchesFilter = driverName === currentFilter;
                    } else {
                        matchesFilter = row[colorBy] === currentFilter;
                    }
                }
                
                return matchesSearch && matchesFilter;
            });

            // Clear existing markers
            markers.forEach(m => {
                map.removeLayer(m.marker);
            });
            markers = [];

            // Generate color mapping - SPECIAL HANDLING FOR COMBINED
            if (colorBy === 'Combined') {
                // Get unique driver names (part before colon)
                const uniqueDrivers = [...new Set(allData.map(row => {
                    const combined = row['Combined'] || '';
                    return combined.split(':')[0];
                }).filter(driver => driver))];
                
                colorMap = {};
                uniqueDrivers.forEach(driver => {
                    colorMap[driver] = getDriverColor(driver);
                });
            } else {
                // Normal color mapping for other attributes
                const uniqueValues = [...new Set(allData.map(row => row[colorBy]))];
                colorMap = {};
                uniqueValues.forEach(value => {
                    colorMap[value] = getColorForValue(value, colorBy);
                });
            }

            // Add new markers
            filteredData.forEach((row, index) => {
                const lat = parseFloat(row['Latitude']);
                const lng = parseFloat(row['Longitude']);
                if (isNaN(lat) || isNaN(lng)) return;

                // Get color - SPECIAL HANDLING FOR COMBINED
                let color;
                if (colorBy === 'Combined') {
                    const driverName = row['Combined'] ? row['Combined'].split(':')[0] : '';
                    color = colorMap[driverName] || '#999999';
                } else {
                    color = colorMap[row[colorBy]] || '#999999';
                }
                
                const isSelected = selectedRow === row;
                
                // Determine marker type based on dog name and callout
                const dogName = (row['Dog Name'] || '').toLowerCase();
                const hasCallout = row['Callout'] && row['Callout'].trim() !== '';
                
                let markerType = 'circle'; // default
                if (dogName.includes('field')) {
                    markerType = 'field';
                } else if (dogName.includes('parking')) {
                    markerType = 'parking';
                } else if (hasCallout) {
                    markerType = 'pin';
                }
                
                const marker = L.marker([lat, lng], {
                    icon: createMarkerIcon(color, isSelected, markerType)
                }).addTo(map);

                // IMPROVED POPUP - HIDES BLANK DISTRICT, SHOWS CAPACITY
                const popupContent = `
                    <strong>üêï ${row['Dog Name']}</strong><br>
                    <strong>üè∑Ô∏è ${row['Combined']}</strong><br>
                    <strong>üìç Address:</strong> ${row['Address']}<br>
                    <strong>üéØ Group:</strong> ${row['Group']}<br>
                    ${row['District'] && row['District'].trim() !== '' ? `<strong>üó∫Ô∏è District:</strong> ${row['District']}<br>` : ''}
                    ${row['Capacity'] && row['Capacity'].trim() !== '' ? `<strong>üë• Capacity:</strong> ${row['Capacity']}<br>` : ''}
                    ${hasCallout ? `<strong>üìù CALLOUT:</strong> <span style="background: yellow; padding: 2px;">${row['Callout']}</span><br>` : ''}
                `;

                marker.bindPopup(popupContent);
                marker.on('click', () => selectMarker(marker, row, index, markerType));

                markers.push({marker, row, index, markerType});
            });

            updateLegend();
            updateStatus(`Showing ${filteredData.length} of ${allData.length} locations`, 'success');
            
            // Update filter status
            const filterStatus = document.getElementById('filterStatus');
            if (currentFilter) {
                filterStatus.textContent = `Filtered by: ${currentFilter}`;
                filterStatus.style.color = '#2196F3';
                filterStatus.style.fontWeight = 'bold';
            } else {
                filterStatus.textContent = 'Showing all markers';
                filterStatus.style.color = '#666';
                filterStatus.style.fontWeight = 'normal';
            }
        }

        // Update legend
        function updateLegend() {
            const colorBy = document.getElementById('colorBy').value;
            const combinedHelp = document.getElementById('combinedHelp');
            let html = '';
            
            if (colorBy === 'Combined') {
                // Show help text for Combined view
                combinedHelp.style.display = 'block';
                
                // For Combined, show driver names (grouped) in legend
                Object.entries(colorMap).forEach(([driverName, color]) => {
                    const isActive = currentFilter === driverName;
                    // Count how many dogs this driver has
                    const driverCount = allData.filter(row => {
                        const combined = row['Combined'] || '';
                        return combined.split(':')[0] === driverName;
                    }).length;
                    
                    html += `<div class="legend-item ${isActive ? 'active' : ''}" onclick="filterByCategory('${driverName}')">
                        <div class="legend-color" style="background-color: ${color}"></div>
                        <span>${driverName} (${driverCount} dogs)</span>
                    </div>`;
                });
            } else {
                // Hide help text for other views
                combinedHelp.style.display = 'none';
                
                // Normal legend for other attributes
                Object.entries(colorMap).forEach(([category, color]) => {
                    const isActive = currentFilter === category;
                    html += `<div class="legend-item ${isActive ? 'active' : ''}" onclick="filterByCategory('${category}')">
                        <div class="legend-color" style="background-color: ${color}"></div>
                        <span>${category}</span>
                    </div>`;
                });
            }
            
            document.getElementById('legendContent').innerHTML = html;
        }

        // Select marker and show details
        function selectMarker(marker, row, index, markerType) {
            // Deselect previous marker
            if (selectedMarker) {
                const prevData = markers.find(m => m.marker === selectedMarker);
                if (prevData) {
                    const colorBy = document.getElementById('colorBy').value;
                    const color = colorMap[prevData.row[colorBy]] || '#999999';
                    selectedMarker.setIcon(createMarkerIcon(color, false, prevData.markerType));
                }
            }

            // Select new marker
            selectedMarker = marker;
            selectedRow = row;
            
            const colorBy = document.getElementById('colorBy').value;
            const color = colorMap[row[colorBy]] || '#999999';
            marker.setIcon(createMarkerIcon(color, true, markerType));

            // Show details with editing capability
            const hasCallout = row['Callout'] && row['Callout'].trim() !== '';
            const detailsHtml = `
                <div style="font-weight: bold; color: #333; margin-bottom: 10px;">
                    üêï ${row['Dog Name']}
                </div>
                
                ${hasCallout ? `
                <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 8px; border-radius: 4px; margin-bottom: 10px;">
                    <strong>üì¢ CALLOUT:</strong><br>
                    <span style="color: #856404; font-weight: bold;">${row['Callout']}</span>
                </div>` : ''}
                
                <div class="dog-info"><strong>üè∑Ô∏è</strong> ${row['Combined']}</div>
                <div class="dog-info"><strong>üìç Address:</strong> ${row['Address']}</div>
                <div class="dog-info"><strong>üéØ Group:</strong> ${row['Group']}</div>
                ${row['District'] && row['District'].trim() !== '' ? `<div class="dog-info"><strong>üó∫Ô∏è District:</strong> ${row['District']}</div>` : ''}
                <div class="dog-info"><strong>üî¢ Dog ID:</strong> ${row['Dog ID']}</div>
                ${row['Capacity'] && row['Capacity'].trim() !== '' ? `<div class="dog-info"><strong>üë• Capacity:</strong> ${row['Capacity']}</div>` : ''}
                ${row['Number of dogs'] ? `<div class="dog-info"><strong>üêï Count:</strong> ${row['Number of dogs']}</div>` : ''}
                <div class="dog-info"><strong>üåê Coordinates:</strong> ${row['Latitude']}, ${row['Longitude']}</div>
                
                <hr style="margin: 15px 0; border: none; border-top: 1px solid #ddd;">
                
                <div style="margin-bottom: 10px;">
                    <label style="font-weight: bold; color: #333; display: block; margin-bottom: 5px;">‚úèÔ∏è Edit:</label>
                    <input type="text" id="editCombined" value="${row['Combined'] || ''}" 
                           style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                </div>
                
                <div style="display: flex; gap: 5px;">
                    <button class="btn btn-primary" onclick="saveCombinedName(${index})" style="flex: 1;">üíæ Save</button>
                    <button class="btn btn-secondary" onclick="cancelEdit()" style="flex: 1;">‚ùå Cancel</button>
                </div>
                
                ${!CONFIG.APPS_SCRIPT_URL || CONFIG.APPS_SCRIPT_URL.trim() === '' ? `
                <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 8px; border-radius: 4px; margin-top: 10px; font-size: 12px;">
                    ‚ö†Ô∏è <strong>Google Sheets Sync:</strong> Configure Apps Script URL in the code to save changes back to your sheet
                </div>` : ''}
            `;
            
            document.getElementById('detailsContent').innerHTML = detailsHtml;
        }

        // Filter functions
        function filterByCategory(category) {
            currentFilter = currentFilter === category ? null : category;
            updateMap();
        }

        function clearFilter() {
            currentFilter = null;
            document.getElementById('searchInput').value = '';
            updateMap();
        }

        // Update quick stats
        function updateQuickStats() {
            if (allData.length === 0) return;
            
            // Get unique drivers from Combined field (part before colon)
            const drivers = [...new Set(allData.map(row => {
                const combined = row['Combined'] || '';
                return combined.split(':')[0];
            }).filter(driver => driver && driver.trim() !== ''))];
            
            const groups = [...new Set(allData.map(row => row['Group']))];
            const districts = [...new Set(allData.map(row => row['District']).filter(d => d && d.trim() !== ''))];
            const withCallouts = allData.filter(row => row['Callout'] && row['Callout'].trim() !== '').length;
            
            const statsHtml = `
                <div class="dog-info">üêï <strong>${allData.length}</strong> total dogs</div>
                <div class="dog-info">üë§ <strong>${drivers.length}</strong> drivers</div>
                <div class="dog-info">üè∑Ô∏è <strong>${groups.length}</strong> groups</div>
                <div class="dog-info">üó∫Ô∏è <strong>${districts.length}</strong> districts</div>
                <div class="dog-info">üìù <strong>${withCallouts}</strong> with callouts</div>
            `;
            
            document.getElementById('quickStats').innerHTML = statsHtml;
        }

        // Show detailed stats
        function showStats() {
            if (allData.length === 0) return;
            
            // Get drivers from Combined field (part before colon)
            const drivers = allData.reduce((acc, row) => {
                const combined = row['Combined'] || '';
                const driverName = combined.split(':')[0];
                if (driverName && driverName.trim() !== '') {
                    acc[driverName] = (acc[driverName] || 0) + 1;
                }
                return acc;
            }, {});
            
            const groups = allData.reduce((acc, row) => {
                acc[row['Group']] = (acc[row['Group']] || 0) + 1;
                return acc;
            }, {});
            
            let statsText = "üìä DETAILED STATISTICS\n\n";
            statsText += "üë§ DRIVERS:\n";
            Object.entries(drivers).sort((a, b) => b[1] - a[1]).forEach(([name, count]) => {
                statsText += `  ${name}: ${count} dogs\n`;
            });
            
            statsText += "\nüè∑Ô∏è GROUPS:\n";
            Object.entries(groups).sort((a, b) => b[1] - a[1]).forEach(([group, count]) => {
                statsText += `  ${group}: ${count} dogs\n`;
            });
            
            alert(statsText);
        }

        // Save combined name function - WITH GOOGLE SHEETS SYNC!
        async function saveCombinedName(index) {
            const newCombined = document.getElementById('editCombined').value;
            if (selectedRow && typeof index === 'number' && allData[index]) {
                // Update the local data first
                selectedRow['Combined'] = newCombined;
                allData[index]['Combined'] = newCombined;
                
                // Try to save to Google Sheets if Apps Script URL is configured
                if (CONFIG.APPS_SCRIPT_URL && CONFIG.APPS_SCRIPT_URL.trim() !== '') {
                    try {
                        updateStatus('üíæ Saving to Google Sheets...', 'loading');
                        
                        const response = await fetch(CONFIG.APPS_SCRIPT_URL, {
                            method: 'POST',
                            mode: 'no-cors',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                action: 'updateCombined',
                                rowIndex: index + 2, // +2 because row 1 is headers and index is 0-based
                                dogId: selectedRow['Dog ID'],
                                newCombined: newCombined
                            })
                        });
                        
                        updateStatus(`‚úÖ Saved to Google Sheets: ${newCombined}`, 'success');
                    } catch (error) {
                        console.error('Error saving to Google Sheets:', error);
                        updateStatus(`‚ö†Ô∏è Saved locally only. Google Sheets error: ${error.message}`, 'error');
                    }
                } else {
                    updateStatus(`‚úÖ Updated locally: ${newCombined} (Configure Apps Script to sync to Google Sheets)`, 'success');
                }
                
                // Refresh the map to show updated colors/legend (important for Combined field changes)
                updateMap();
                
                // Update the details display
                if (selectedMarker) {
                    const markerData = markers.find(m => m.marker === selectedMarker);
                    if (markerData) {
                        selectMarker(selectedMarker, selectedRow, index, markerData.markerType);
                    }
                }
            }
        }

        // Show Apps Script setup help
        function showAppsScriptHelp() {
            const helpText = `üìñ GOOGLE APPS SCRIPT SETUP

To enable saving edits back to your Google Sheet:

1Ô∏è‚É£ Go to script.google.com
2Ô∏è‚É£ Create a new project
3Ô∏è‚É£ Replace the default code with this:

function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    const sheet = SpreadsheetApp.openById('${CONFIG.SHEET_ID}').getSheetByName('${CONFIG.WORKSHEET_NAME}');
    
    if (data.action === 'updateCombined') {
      // Update the Combined column (column H)
      sheet.getRange(data.rowIndex, 8).setValue(data.newCombined);
      return ContentService.createTextOutput(JSON.stringify({success: true}));
    }
    
    return ContentService.createTextOutput(JSON.stringify({error: 'Unknown action'}));
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({error: error.toString()}));
  }
}

4Ô∏è‚É£ Deploy as Web App
5Ô∏è‚É£ Set permissions to "Anyone"
6Ô∏è‚É£ Copy the Web App URL
7Ô∏è‚É£ Paste it in CONFIG.APPS_SCRIPT_URL in this code

Then your edits will sync back to Google Sheets!`;

            alert(helpText);
        }

        // Cancel edit function
        function cancelEdit() {
            if (selectedMarker && selectedRow) {
                const markerData = markers.find(m => m.marker === selectedMarker);
                if (markerData) {
                    const index = allData.findIndex(row => row === selectedRow);
                    selectMarker(selectedMarker, selectedRow, index, markerData.markerType);
                }
            }
        }

        // Refresh data
        function refreshData() {
            selectedMarker = null;
            selectedRow = null;
            currentFilter = null;
            document.getElementById('detailsContent').innerHTML = '<div class="no-selection">Click a marker on the map to see details</div>';
            loadData();
        }

        // Status update
        function updateStatus(message, type = '') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }

        // Initialize everything
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üÜï Loading IMPROVED Dog Map v2 with street names and Google Sheets sync!');
            initMap();
            loadData();
        });
    </script>
</body>
</html>
