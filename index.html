<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üêï Dog Walking Interactive Map - Wellesley Area</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f8f9fa;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }

        .header h1 {
            font-size: 1.8em;
            margin-bottom: 5px;
        }

        .controls {
            background: white;
            padding: 10px 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
            flex-shrink: 0;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-group label {
            font-weight: 600;
            color: #333;
        }

        select, input {
            padding: 6px 10px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
        }

        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .left-panel {
            width: 300px;
            background: white;
            border-right: 2px solid #e1e5e9;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .legend-section {
            border-bottom: 2px solid #e1e5e9;
            padding: 15px;
            overflow-y: auto;
            max-height: 300px;
        }

        .legend h3 {
            margin-bottom: 10px;
            color: #333;
            font-size: 16px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 14px;
            cursor: pointer;
            padding: 8px;
            border-radius: 4px;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .legend-item:hover {
            background-color: #f8f9fa;
            border-color: #dee2e6;
            transform: translateX(2px);
        }

        .legend-item.active {
            background-color: #e3f2fd;
            border-color: #2196F3;
            font-weight: bold;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 10px;
            border: 2px solid #333;
            flex-shrink: 0;
        }

        .edit-section {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
        }

        .edit-section h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 16px;
        }

        .no-selection {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            margin-top: 50px;
        }

        .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            font-size: 14px;
            margin: 2px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .btn-clear {
            background: #28a745;
            color: white;
        }

        .btn-clear:hover {
            background: #218838;
        }

        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .status {
            background: white;
            padding: 8px 20px;
            text-align: center;
            font-weight: 600;
            border-top: 1px solid #e1e5e9;
            font-size: 14px;
            flex-shrink: 0;
        }

        .status.loading {
            background: #fff3cd;
            color: #856404;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
        }

        .dog-info {
            font-size: 12px;
            color: #666;
            margin: 5px 0;
        }

        .stats-box {
            background: #f8f9fa;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #667eea;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üêï Dog Walking Interactive Map - Wellesley Area</h1>
        <p>üìç Dogs ‚Ä¢ üöó Drivers ‚Ä¢ üéØ Groups ‚Ä¢ Service Area Coverage</p>
    </div>

    <div class="controls">
        <div class="control-group">
            <label for="colorBy">Color by:</label>
            <select id="colorBy">
                <option value="Name">Driver Name</option>
                <option value="Group">Group</option>
                <option value="District">District</option>
            </select>
        </div>
        
        <div class="control-group">
            <label for="searchInput">Search:</label>
            <input type="text" id="searchInput" placeholder="Search dogs, addresses, drivers..." />
        </div>

        <div class="control-group">
            <button class="btn btn-secondary" onclick="refreshData()">üîÑ Refresh</button>
            <button class="btn btn-secondary" onclick="showStats()">üìä Stats</button>
        </div>
    </div>

    <div class="main-content">
        <div class="left-panel">
            <div class="legend-section">
                <h3>üé® Legend (Click to Filter)</h3>
                <div id="filterStatus" style="font-size: 12px; color: #666; margin-bottom: 10px; font-style: italic;"></div>
                <div id="legendContent">Loading...</div>
                <div style="text-align: center; margin-top: 10px;">
                    <button class="btn btn-clear" onclick="clearFilter()" style="width: 100%;">Show All</button>
                </div>
            </div>
            
            <div class="edit-section">
                <h3>üìã Details</h3>
                <div id="detailsContent" class="no-selection">
                    Click a marker on the map to see details
                </div>
                
                <div class="stats-box" id="statsBox">
                    <strong>üìä Quick Stats:</strong>
                    <div id="quickStats">Loading...</div>
                </div>
            </div>
        </div>

        <div class="map-container">
            <div id="map"></div>
        </div>
    </div>

    <div class="status" id="status">Loading dog walking data...</div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // Configuration - using your exact sheet details
        const CONFIG = {
            SHEET_ID: '1mg8d5CLxSR54KhNUL8SpL5jzrGN-bghTsC9vxSK8lR0',
            WORKSHEET_NAME: 'Map',
            API_KEY: 'AIzaSyAGLteYp1k98SZo0FMClRgBX0LBsgpMxqI',
            // Wellesley, MA coordinates
            DEFAULT_LAT: 42.2968,
            DEFAULT_LNG: -71.2636,
            DEFAULT_ZOOM: 11
        };

        // Color mapping for drivers
        const DRIVER_COLORS = {
            'Nate': '#1f77b4', 'Aidan': '#ff7f0e', 'Sarah': '#2ca02c', 'Victor': '#d62728',
            'Emily': '#9467bd', 'Mike': '#8c564b', 'Lisa': '#e377c2', 'David': '#7f7f7f',
            'Anna': '#bcbd22', 'Chris': '#17becf', 'Jess': '#ff9896', 'Tom': '#98df8a',
            'Sam': '#c5b0d5', 'Alex': '#c49c94', 'Jordan': '#f7b6d3', 'Taylor': '#c7c7c7'
        };

        // Global variables
        let map, markers = [], allData = [], filteredData = [], colorMap = {};
        let selectedMarker = null, selectedRow = null, currentFilter = null;

        // Helper functions
        function getDriverColor(name) {
            if (!name) return '#999999';
            return DRIVER_COLORS[name] || '#' + Math.floor(Math.random()*16777215).toString(16);
        }

        function getColorForValue(value, attribute) {
            if (attribute === 'Name') return getDriverColor(value);
            
            // Generate consistent colors for other attributes
            const colors = ['#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd', '#8c564b', '#e377c2', '#7f7f7f', '#bcbd22', '#17becf'];
            let hash = 0;
            for (let i = 0; i < value.length; i++) {
                hash = value.charCodeAt(i) + ((hash << 5) - hash);
            }
            return colors[Math.abs(hash) % colors.length];
        }

        function createMarkerIcon(color, isSelected = false) {
            const size = 20;
            const strokeColor = isSelected ? '#000000' : '#ffffff';
            const strokeWidth = isSelected ? 3 : 2;
            
            return L.divIcon({
                html: `<div style="width: ${size}px; height: ${size}px; background-color: ${color}; border: ${strokeWidth}px solid ${strokeColor}; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>`,
                className: 'custom-marker',
                iconSize: [size, size],
                iconAnchor: [size/2, size/2]
            });
        }

        // Initialize map
        function initMap() {
            map = L.map('map').setView([CONFIG.DEFAULT_LAT, CONFIG.DEFAULT_LNG], CONFIG.DEFAULT_ZOOM);
            
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}{r}.png', {
                attribution: '¬© OpenStreetMap contributors, ¬© CARTO',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);

            document.getElementById('colorBy').addEventListener('change', updateMap);
            document.getElementById('searchInput').addEventListener('input', updateMap);
        }

        // Load data from Google Sheets
        async function loadData() {
            updateStatus('Loading data...', 'loading');
            
            try {
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}/values/${CONFIG.WORKSHEET_NAME}?key=${CONFIG.API_KEY}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (!data.values || data.values.length < 2) {
                    throw new Error('No data found in the sheet');
                }
                
                const headers = data.values[0];
                const rows = data.values.slice(1);
                
                allData = rows.map(row => {
                    const obj = {};
                    headers.forEach((header, index) => {
                        obj[header] = row[index] || '';
                    });
                    return obj;
                }).filter(row => {
                    const lat = parseFloat(row['Latitude']);
                    const lng = parseFloat(row['Longitude']);
                    return !isNaN(lat) && !isNaN(lng) && row['Dog Name'] && lat !== 0 && lng !== 0;
                });

                updateStatus(`Loaded ${allData.length} locations!`, 'success');
                updateQuickStats();
                updateMap();
                
            } catch (error) {
                updateStatus(`Error: ${error.message}`, 'error');
                console.error('Data loading error:', error);
            }
        }

        // Update map with current filters
        function updateMap() {
            const colorBy = document.getElementById('colorBy').value;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            // Filter data
            filteredData = allData.filter(row => {
                const searchText = `${row['Dog Name']} ${row['Address']} ${row['Name']} ${row['District']}`.toLowerCase();
                const matchesSearch = searchText.includes(searchTerm);
                
                let matchesFilter = currentFilter === null;
                if (!matchesFilter && currentFilter !== null) {
                    matchesFilter = row[colorBy] === currentFilter;
                }
                
                return matchesSearch && matchesFilter;
            });

            // Clear existing markers
            markers.forEach(m => map.removeLayer(m.marker));
            markers = [];

            // Generate color mapping
            const uniqueValues = [...new Set(allData.map(row => row[colorBy]))];
            colorMap = {};
            uniqueValues.forEach(value => {
                colorMap[value] = getColorForValue(value, colorBy);
            });

            // Add new markers
            filteredData.forEach((row, index) => {
                const lat = parseFloat(row['Latitude']);
                const lng = parseFloat(row['Longitude']);
                if (isNaN(lat) || isNaN(lng)) return;

                const color = colorMap[row[colorBy]] || '#999999';
                const isSelected = selectedRow === row;
                
                const marker = L.marker([lat, lng], {
                    icon: createMarkerIcon(color, isSelected)
                }).addTo(map);

                const popupContent = `
                    <strong>üêï ${row['Dog Name']}</strong><br>
                    <strong>üë§ Driver:</strong> ${row['Name']}<br>
                    <strong>üìç Address:</strong> ${row['Address']}<br>
                    <strong>üè∑Ô∏è Group:</strong> ${row['Group']}<br>
                    <strong>üó∫Ô∏è District:</strong> ${row['District']}<br>
                    ${row['Callout'] ? `<strong>üìù Notes:</strong> ${row['Callout']}<br>` : ''}
                `;

                marker.bindPopup(popupContent);
                marker.on('click', () => selectMarker(marker, row, index));

                markers.push({marker, row, index});
            });

            updateLegend();
            updateStatus(`Showing ${filteredData.length} of ${allData.length} locations`, 'success');
            
            // Update filter status
            const filterStatus = document.getElementById('filterStatus');
            if (currentFilter) {
                filterStatus.textContent = `Filtered by: ${currentFilter}`;
                filterStatus.style.color = '#2196F3';
                filterStatus.style.fontWeight = 'bold';
            } else {
                filterStatus.textContent = 'Showing all markers';
                filterStatus.style.color = '#666';
                filterStatus.style.fontWeight = 'normal';
            }
        }

        // Update legend
        function updateLegend() {
            let html = '';
            Object.entries(colorMap).forEach(([category, color]) => {
                const isActive = currentFilter === category;
                html += `<div class="legend-item ${isActive ? 'active' : ''}" onclick="filterByCategory('${category}')">
                    <div class="legend-color" style="background-color: ${color}"></div>
                    <span>${category}</span>
                </div>`;
            });
            document.getElementById('legendContent').innerHTML = html;
        }

        // Select marker and show details
        function selectMarker(marker, row, index) {
            // Deselect previous marker
            if (selectedMarker) {
                const prevData = markers.find(m => m.marker === selectedMarker);
                if (prevData) {
                    const colorBy = document.getElementById('colorBy').value;
                    const color = colorMap[prevData.row[colorBy]] || '#999999';
                    selectedMarker.setIcon(createMarkerIcon(color, false));
                }
            }

            // Select new marker
            selectedMarker = marker;
            selectedRow = row;
            
            const colorBy = document.getElementById('colorBy').value;
            const color = colorMap[row[colorBy]] || '#999999';
            marker.setIcon(createMarkerIcon(color, true));

            // Show details
            const detailsHtml = `
                <div style="font-weight: bold; color: #333; margin-bottom: 10px;">
                    üêï ${row['Dog Name']}
                </div>
                <div class="dog-info"><strong>üë§ Driver:</strong> ${row['Name']}</div>
                <div class="dog-info"><strong>üìç Address:</strong> ${row['Address']}</div>
                <div class="dog-info"><strong>üè∑Ô∏è Group:</strong> ${row['Group']}</div>
                <div class="dog-info"><strong>üó∫Ô∏è District:</strong> ${row['District']}</div>
                <div class="dog-info"><strong>üî¢ Dog ID:</strong> ${row['Dog ID']}</div>
                ${row['Callout'] ? `<div class="dog-info"><strong>üìù Notes:</strong> ${row['Callout']}</div>` : ''}
                ${row['Number of dogs'] ? `<div class="dog-info"><strong>üêï Count:</strong> ${row['Number of dogs']}</div>` : ''}
                <div class="dog-info"><strong>üåê Coordinates:</strong> ${row['Latitude']}, ${row['Longitude']}</div>
            `;
            
            document.getElementById('detailsContent').innerHTML = detailsHtml;
        }

        // Filter functions
        function filterByCategory(category) {
            currentFilter = currentFilter === category ? null : category;
            updateMap();
        }

        function clearFilter() {
            currentFilter = null;
            document.getElementById('searchInput').value = '';
            updateMap();
        }

        // Update quick stats
        function updateQuickStats() {
            if (allData.length === 0) return;
            
            const drivers = [...new Set(allData.map(row => row['Name']))];
            const groups = [...new Set(allData.map(row => row['Group']))];
            const districts = [...new Set(allData.map(row => row['District']))];
            
            const statsHtml = `
                <div class="dog-info">üêï <strong>${allData.length}</strong> total dogs</div>
                <div class="dog-info">üë§ <strong>${drivers.length}</strong> drivers</div>
                <div class="dog-info">üè∑Ô∏è <strong>${groups.length}</strong> groups</div>
                <div class="dog-info">üó∫Ô∏è <strong>${districts.length}</strong> districts</div>
            `;
            
            document.getElementById('quickStats').innerHTML = statsHtml;
        }

        // Show detailed stats
        function showStats() {
            if (allData.length === 0) return;
            
            const drivers = allData.reduce((acc, row) => {
                acc[row['Name']] = (acc[row['Name']] || 0) + 1;
                return acc;
            }, {});
            
            const groups = allData.reduce((acc, row) => {
                acc[row['Group']] = (acc[row['Group']] || 0) + 1;
                return acc;
            }, {});
            
            let statsText = "üìä DETAILED STATISTICS\n\n";
            statsText += "üë§ DRIVERS:\n";
            Object.entries(drivers).sort((a, b) => b[1] - a[1]).forEach(([name, count]) => {
                statsText += `  ${name}: ${count} dogs\n`;
            });
            
            statsText += "\nüè∑Ô∏è GROUPS:\n";
            Object.entries(groups).sort((a, b) => b[1] - a[1]).forEach(([group, count]) => {
                statsText += `  ${group}: ${count} dogs\n`;
            });
            
            alert(statsText);
        }

        // Status update
        function updateStatus(message, type = '') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }

        // Refresh data
        function refreshData() {
            selectedMarker = null;
            selectedRow = null;
            currentFilter = null;
            document.getElementById('detailsContent').innerHTML = '<div class="no-selection">Click a marker on the map to see details</div>';
            loadData();
        }

        // Initialize everything
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            loadData();
        });
    </script>
</body>
</html>
