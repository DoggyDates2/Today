<!-- FULL UPDATED SCRIPT STARTS HERE -->
<!-- (NOTE: Only the relevant JS parts have been updated. HTML and CSS remain unchanged.) -->

<script>
    // Configuration
    const CONFIG = {
        SHEET_ID: '1mg8d5CLxSR54KhNUL8SpL5jzrGN-bghTsC9vxSK8lR0',
        WORKSHEET_NAME: 'Map',
        API_KEY: 'AIzaSyAGLteYp1k98SZo0FMClRgBX0LBsgpMxqI',
        APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbw7UA6k9yO2z10sI4tQ22n8eBz2lerJin5PJ2Yz7nSXsEzNbIyuDDMK7QAlRpuC-4vFRw/exec',
        DEFAULT_LAT: 42.2968,
        DEFAULT_LNG: -71.2636,
        DEFAULT_ZOOM: 11,
        MAX_BOUNDS: {
            NORTH: 42.5869,
            SOUTH: 42.0067,
            EAST: -70.9336,
            WEST: -71.5936
        }
    };

    // Color map now based on driver from 'Combined' column
    function generateColorMap(attribute) {
        const drivers = [...new Set(allData.map(row => (row['Combined'] || '').split(':')[0].trim()))];
        colorMap = {};
        drivers.forEach(driver => {
            const key = driver || 'Unknown';
            colorMap[key] = getDriverColor(key);
        });
    }

    function updateMap() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const colorBy = 'Combined';

        filteredData = allData.filter(row => {
            const searchText = `${row['Dog Name']} ${row['Address']} ${(row['Combined'] || '')}`.toLowerCase();
            return searchText.includes(searchTerm);
        });

        markers.forEach(m => map.removeLayer(m.marker));
        markers = [];
        generateColorMap(colorBy);

        filteredData.forEach((row, index) => {
            const lat = parseFloat(row['Latitude']);
            const lng = parseFloat(row['Longitude']);
            if (isNaN(lat) || isNaN(lng)) return;

            const driverKey = (row['Combined'] || '').split(':')[0].trim();
            const color = colorMap[driverKey] || '#999999';

            const dogName = row['Dog Name'] || '';
            const group = row['Group'] || '';
            const isSelected = selectedRow === row;
            const isParking = dogName.toLowerCase().includes('parking');
            const isField = dogName.toLowerCase().includes('field');
            const hasColon = group.toString().includes(':');

            let marker, markerType = 'pin';
            if (isParking) {
                marker = L.marker([lat, lng], {icon: createParkingIcon(color, isSelected)}).addTo(map);
                markerType = 'parking';
            } else if (isField) {
                marker = L.marker([lat, lng], {icon: createFieldIcon(color, isSelected)}).addTo(map);
                markerType = 'field';
            } else if (hasColon) {
                marker = L.marker([lat, lng], {icon: createDiamondIcon(color, isSelected)}).addTo(map);
                markerType = 'diamond';
            } else {
                marker = L.marker([lat, lng], {icon: createPinIcon(color, isSelected)}).addTo(map);
                markerType = 'pin';
            }

            const originalIndex = allData.findIndex(originalRow =>
                originalRow['Dog ID'] === row['Dog ID'] ||
                (originalRow['Dog Name'] === row['Dog Name'] && originalRow['Address'] === row['Address'])
            );

            marker.on('click', () => selectMarker(marker, row, originalIndex));

            const combinedTitle = row['Combined'] || row['Dog Name'];
            const columnK = row['Column K'] || '';
            const tooltipText = `
                <strong>${markerType === 'diamond' ? '‚ô¶Ô∏è' : markerType === 'field' ? '‚íª' : markerType === 'parking' ? '‚ìÖ' : 'üìç'} ${combinedTitle}</strong><br>
                Driver: ${driverKey || 'No Driver'}<br>
                ${row['Address']}<br>
                Capacity: ${row['Capacity'] || 'Not set'}
                ${columnK && columnK.trim() !== '' ? `<br>${columnK}` : ''}`;

            marker.bindTooltip(tooltipText, {permanent: false, direction: 'bottom', offset: [0, 10]});
            markers.push({marker, row, index: originalIndex, markerType});
        });

        updateLegend();
        updateStatus(`Showing ${filteredData.length} of ${allData.length} locations`, 'success');
    }

    function updateLegend() {
        const html = Object.entries(colorMap).map(([category, color]) => {
            const isActive = currentFilter === category;
            const escapedCategory = category.replace(/'/g, "\\'").replace(/"/g, '\\"');
            return `<div class="legend-item ${isActive ? 'active' : ''}" onclick="filterByCategory('${escapedCategory}')">
                        <div class="legend-color" style="background-color: ${color}"></div><span>${category}</span>
                    </div>`;
        }).join('');
        document.getElementById('legendContent').innerHTML = html;
    }
</script>
<!-- FULL UPDATED SCRIPT ENDS HERE -->
