<!-- FULL UPDATED SCRIPT STARTS HERE -->
<!-- Updated full script with map init and data loading -->

<script>
    const CONFIG = {
        SHEET_ID: '1mg8d5CLxSR54KhNUL8SpL5jzrGN-bghTsC9vxSK8lR0',
        WORKSHEET_NAME: 'Map',
        API_KEY: 'AIzaSyAGLteYp1k98SZo0FMClRgBX0LBsgpMxqI',
        DEFAULT_LAT: 42.2968,
        DEFAULT_LNG: -71.2636,
        DEFAULT_ZOOM: 11,
        MAX_BOUNDS: {
            NORTH: 42.5869,
            SOUTH: 42.0067,
            EAST: -70.9336,
            WEST: -71.5936
        }
    };

    let map, markers = [], allData = [], filteredData = [], colorMap = {}, currentFilter = null, selectedRow = null;

    function getDriverColor(name) {
        const colors = ['#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd', '#8c564b', '#e377c2'];
        const hash = Array.from(name).reduce((acc, char) => acc + char.charCodeAt(0), 0);
        return colors[hash % colors.length];
    }

    function initMap() {
        map = L.map('map').setView([CONFIG.DEFAULT_LAT, CONFIG.DEFAULT_LNG], CONFIG.DEFAULT_ZOOM);
        const bounds = L.latLngBounds(
            [CONFIG.MAX_BOUNDS.SOUTH, CONFIG.MAX_BOUNDS.WEST],
            [CONFIG.MAX_BOUNDS.NORTH, CONFIG.MAX_BOUNDS.EAST]
        );
        map.setMaxBounds(bounds);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18,
            attribution: 'Â© OpenStreetMap'
        }).addTo(map);
    }

    async function loadData() {
        try {
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}/values/${CONFIG.WORKSHEET_NAME}?key=${CONFIG.API_KEY}`;
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

            const data = await response.json();
            const headers = data.values[0];
            const rows = data.values.slice(1);

            allData = rows.map(row => {
                const obj = {};
                headers.forEach((header, i) => obj[header] = row[i] || '');
                return obj;
            }).filter(row => {
                const lat = parseFloat(row['Latitude']);
                const lng = parseFloat(row['Longitude']);
                return !isNaN(lat) && !isNaN(lng);
            });

            updateMap();
        } catch (err) {
            console.error('Failed to load data:', err);
        }
    }

    function generateColorMap() {
        const drivers = [...new Set(allData.map(row => (row['Combined'] || '').split(':')[0].trim()))];
        colorMap = {};
        drivers.forEach(driver => {
            const key = driver || 'Unknown';
            colorMap[key] = getDriverColor(key);
        });
    }

    function updateMap() {
        const searchTerm = document.getElementById('searchInput')?.value.toLowerCase() || '';
        filteredData = allData.filter(row => {
            const searchText = `${row['Dog Name']} ${row['Address']} ${(row['Combined'] || '')}`.toLowerCase();
            return searchText.includes(searchTerm);
        });

        markers.forEach(m => map.removeLayer(m.marker));
        markers = [];
        generateColorMap();

        filteredData.forEach((row) => {
            const lat = parseFloat(row['Latitude']);
            const lng = parseFloat(row['Longitude']);
            if (isNaN(lat) || isNaN(lng)) return;

            const driverKey = (row['Combined'] || '').split(':')[0].trim();
            const color = colorMap[driverKey] || '#999999';

            const marker = L.circleMarker([lat, lng], {
                radius: 8,
                fillColor: color,
                color: '#000',
                weight: 1,
                opacity: 1,
                fillOpacity: 0.8
            }).addTo(map);

            marker.bindTooltip(`${row['Combined'] || 'Unknown'}<br>${row['Address'] || ''}`);
            markers.push({ marker });
        });

        updateLegend();
    }

    function updateLegend() {
        const html = Object.entries(colorMap).map(([category, color]) => {
            return `<div class="legend-item">
                        <div class="legend-color" style="background-color: ${color}"></div><span>${category}</span>
                    </div>`;
        }).join('');
        const legend = document.getElementById('legendContent');
        if (legend) legend.innerHTML = html;
    }

    document.addEventListener('DOMContentLoaded', () => {
        initMap();
        loadData();
    });
</script>
<!-- FULL UPDATED SCRIPT ENDS HERE -->
